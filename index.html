<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Oreo Elite Tracker</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        :root { --blue: #007AFF; --red: #FF3B30; --green: #34C759; --orange: #FF9500; }
        body { font-family: -apple-system, sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; background: #f8f8f8; }
        
        .header { background: white; padding: 12px; border-bottom: 1px solid #ddd; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .status-row { display: flex; justify-content: space-between; align-items: center; }
        .pill { padding: 4px 10px; border-radius: 12px; color: white; font-size: 10px; font-weight: bold; text-transform: uppercase; }
        .bg-green { background: var(--green); }
        .bg-red { background: var(--red); }
        .bg-orange { background: var(--orange); }
        .bg-gray { background: #999; }

        #map { flex: 1; }

        .side-menu { position: absolute; right: 15px; top: 120px; display: flex; flex-direction: column; gap: 12px; z-index: 1000; }
        .btn-circle { width: 50px; height: 50px; border-radius: 50%; border: none; background: white; box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-size: 20px; cursor: pointer; transition: 0.1s; display: flex; align-items: center; justify-content: center; }
        .btn-circle:active { transform: scale(0.85); }

        .mode-bar { background: white; padding: 15px; display: flex; justify-content: space-around; border-top: 1px solid #ddd; z-index: 1000; }
        .m-btn { border: none; padding: 10px 18px; border-radius: 20px; font-weight: bold; font-size: 11px; background: #eee; cursor: pointer; }
        .m-active { background: var(--blue); color: white; }
    </style>
</head>
<body>

<div class="header">
    <div class="status-row">
        <b>üêæ OREO TRACKER</b>
        <div>
            <span id="conn-pill" class="pill bg-red">OFFLINE</span>
            <span id="gps-pill" class="pill bg-gray">GPS: --</span>
        </div>
    </div>
    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; font-size: 11px; color:#666; margin-top:10px; text-align:center;">
        <span>üîã <b id="bat-txt">--%</b></span>
        <span>üì∂ Sig: <b id="sig-txt">--</b></span>
        <span>üõ∞Ô∏è Sats: <b id="sat-txt">0</b></span>
    </div>
    <div style="text-align: center; font-size: 10px; color: #999; margin-top: 5px;">
        Last update: <span id="time-ago">---</span>
    </div>
</div>

<div id="map"></div>

<div class="side-menu">
    <button class="btn-circle" onclick="centerMap()">üéØ</button>
    <button class="btn-circle" onclick="window.location.reload()">üîÑ</button>
</div>

<div class="mode-bar">
    <button id="b-HOME" class="m-btn" onclick="sendMode('HOME')">HOME</button>
    <button id="b-WALK" class="m-btn" onclick="sendMode('WALK')">WALK</button>
    <button id="b-LOST" class="m-btn" onclick="sendMode('LOST')">LOST</button>
    <button id="b-SAVE" class="m-btn" onclick="sendMode('SAVE')">SAVE</button>
</div>

<script>
    const TOPIC = "Oreo_Safe_Tracker";
    let trackerPos = [14.5995, 120.9842], lastMsgTime = 0;

    let map = L.map('map', {zoomControl: false}).setView(trackerPos, 15);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);
    let dogMarker = L.marker(trackerPos, {icon: L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/616/616408.png', iconSize:[40,40]})}).addTo(map);

    const client = new Paho.MQTT.Client("wss://broker.hivemq.com:8884/mqtt", "web_" + Math.random());
    
    client.onMessageArrived = (msg) => {
        if(msg.destinationName.includes("data")) {
            let data = JSON.parse(msg.payloadString);
            lastMsgTime = Date.now();
            
            // Stats
            document.getElementById('bat-txt').innerText = Math.round((parseFloat(data.bat)-3.4)*125) + "%";
            document.getElementById('sig-txt').innerText = data.csq + " CSQ";
            document.getElementById('sat-txt').innerText = data.sats;
            
            // Status Pills
            document.getElementById('conn-pill').innerText = "ONLINE";
            document.getElementById('conn-pill').className = "pill bg-green";
            
            const gp = document.getElementById('gps-pill');
            gp.innerText = "GPS: " + data.gps;
            gp.className = data.gps === "FIX" ? "pill bg-green" : "pill bg-orange";

            if(data.lat != "0.0") {
                trackerPos = [parseFloat(data.lat), parseFloat(data.lng)];
                dogMarker.setLatLng(trackerPos);
            }
            updateModeButtons(data.mode);
        }
    };

    function updateModeButtons(m) {
        document.querySelectorAll('.m-btn').forEach(b => b.classList.remove('m-active'));
        const activeBtn = document.getElementById('b-'+m);
        if(activeBtn) activeBtn.classList.add('m-active');
    }

    setInterval(() => {
        if(lastMsgTime === 0) return;
        let diff = Math.floor((Date.now() - lastMsgTime) / 1000);
        document.getElementById('time-ago').innerText = diff < 60 ? diff + "s ago" : Math.floor(diff/60) + "m ago";

        if(diff > 120) { // Offline if silent for 2 mins
            document.getElementById('conn-pill').innerText = "OFFLINE";
            document.getElementById('conn-pill').className = "pill bg-red";
        }
    }, 1000);

    function sendMode(m) { client.send(new Paho.MQTT.Message(m), TOPIC + "/setMode"); }
    function centerMap() { map.flyTo(trackerPos, 18); }

    client.connect({useSSL:true, onSuccess:() => client.subscribe(TOPIC + "/data")});
</script>
</body>
</html>
