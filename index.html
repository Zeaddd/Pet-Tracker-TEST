<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Oreo Tracker Pro</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    
    <style>
        :root { --primary-blue: #0066FF; --bg-grey: #F2F2F7; --text-dark: #1C1C1E; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0; background: var(--bg-grey); display: flex; flex-direction: column; height: 100vh; overflow: hidden; color: var(--text-dark); }
        
        /* HEADER */
        .header-bar { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: white; font-size: 16px; font-weight: 700; border-bottom: 1px solid #e5e5ea; }
        .header-title { display: flex; align-items: center; gap: 8px; }
        .refresh-btn { background: #f2f2f7; border: none; padding: 8px 12px; border-radius: 20px; font-size: 16px; cursor: pointer; color: var(--primary-blue); font-weight: bold; }
        .refresh-btn:active { background: #e5e5ea; }
        .status-pill { padding: 4px 10px; border-radius: 12px; font-size: 11px; display: flex; align-items: center; gap: 5px; background: #f2f2f7; color: #666; font-weight: 600;}
        .dot { height: 6px; width: 6px; background-color: #bbb; border-radius: 50%; display: inline-block; }

        /* INFO PANEL */
        .info-panel { background: white; padding: 15px 20px; display: flex; flex-direction: column; gap: 15px; border-bottom-left-radius: 24px; border-bottom-right-radius: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); z-index: 2; }
        .info-stats { display: flex; justify-content: space-around; text-align: center; }
        .info-label { font-size: 11px; color: #8e8e93; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; display: block; }
        .info-val { font-size: 18px; font-weight: 700; }
        .fence-row { display: flex; justify-content: space-between; align-items: center; background: #f9f9f9; padding: 10px 15px; border-radius: 16px; font-size: 13px; font-weight: 500;}
        
        /* SWITCH */
        .switch { position: relative; display: inline-block; width: 40px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #e9e9ea; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        input:checked + .slider { background-color: #34c759; }
        input:checked + .slider:before { transform: translateX(16px); }

        /* MAP & FABs */
        .map-container { flex-grow: 1; position: relative; }
        #map { height: 100%; width: 100%; z-index: 1; }
        .fab-container { position: absolute; bottom: 30px; right: 20px; display: flex; flex-direction: column; gap: 12px; z-index: 1000; }
        .fab-btn { width: 48px; height: 48px; background: white; border-radius: 50%; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border: none; font-size: 22px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-dark); }
        .fab-btn:active { transform: scale(0.95); background: #f2f2f2; }
        .fab-btn.tracking-active { background: var(--primary-blue); color: white; }

        /* BOTTOM CONTROLS */
        .bottom-sheet { background: white; padding: 20px; border-top-left-radius: 24px; border-top-right-radius: 24px; box-shadow: 0 -4px 20px rgba(0,0,0,0.08); z-index: 1001; }
        .mode-label { font-size: 16px; font-weight: 700; margin-bottom: 15px; display: block; }
        .mode-controls { display: flex; gap: 10px; }
        .btn-mode { flex: 1; border: none; padding: 14px; border-radius: 30px; color: white; font-weight: 700; font-size: 13px; cursor: pointer; transition: 0.2s; background: #C7C7CC; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
        .btn-mode:active { transform: scale(0.97); }
        .active-SAFE { background: #34c759 !important; } 
        .active-WALK { background: #ff9500 !important; } 
        .active-LOST { background: #ff3b30 !important; } 
        .leaflet-routing-container { display: none; }

        /* LOGS MODAL */
        #logs-modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-height: 60%; overflow-y: scroll; border-radius: 12px; }
        .close-logs { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-logs:hover, .close-logs:focus { color: black; text-decoration: none; }
        .log-entry { font-family: monospace; font-size: 12px; border-bottom: 1px solid #eee; padding: 4px 0; }
    </style>
</head>
<body>

<div class="header-bar">
    <div class="header-title"><span style="font-size: 20px;">üê∂</span> Oreo Tracker</div>
    <div style="display:flex; gap:8px; align-items:center;">
        <div class="status-pill"><span id="dot-sys" class="dot" style="background:#ff3b30;"></span><span id="status">OFFLINE</span></div>
        <button class="refresh-btn" onclick="window.location.reload()">üîÑ</button>
    </div>
</div>

<div class="info-panel">
    <div class="info-stats">
        <div><span class="info-label">Battery</span><span id="bat-val" class="info-val">--%</span></div>
        <div><span class="info-label">Distance</span><span id="dist-val" class="info-val">-- m</span></div>
        <div><span class="info-label">GPS Signal</span><span id="gps-status" class="info-val" style="font-size:14px; color:#ff9500;">WAIT</span></div>
    </div>
    <div class="fence-row">
        <span>üõ°Ô∏è Geofence (Drag Pin)</span>
        <label class="switch"><input type="checkbox" id="fence-toggle" onchange="toggleFence(this.checked)"><span class="slider"></span></label>
    </div>
</div>

<div class="map-container">
    <div id="map"></div>
    <div class="fab-container">
        <button class="fab-btn" onclick="toggleLogs()">üìú</button> <button class="fab-btn" onclick="toggleMapStyle()">üó∫Ô∏è</button>
        <button id="track-btn-fab" class="fab-btn" onclick="toggleTracking()">üë£</button>
        <button class="fab-btn" onclick="centerMap()">üéØ</button>
    </div>
</div>

<div class="bottom-sheet">
    <span class="mode-label">Tracking Mode</span>
    <div class="mode-controls">
        <button id="mode-SAFE" class="btn-mode" onclick="sendMode('SAFE')">üè† SAFE</button>
        <button id="mode-WALK" class="btn-mode" onclick="sendMode('WALK')">ü¶Æ WALK</button>
        <button id="mode-LOST" class="btn-mode" onclick="sendMode('LOST')">üö® LOST</button>
    </div>
</div>

<div id="logs-modal">
  <div class="modal-content">
    <span class="close-logs" onclick="toggleLogs()">&times;</span>
    <h3>System Logs</h3>
    <div id="log-container"></div>
  </div>
</div>

<script>
    const TOPIC_BASE = "Oreo_Safe_Tracker";
    let trackerPos = [14.5995, 120.9842], userPos = null;
    let routingControl = null, isTracking = false;
    let fenceCircle = null, homeMarker = null;

    // Dog Icon
    const dogIcon = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/616/616408.png', // Replace with your desired dog icon URL
        iconSize: [40, 40],
        iconAnchor: [20, 40],
        popupAnchor: [0, -40]
    });

    const mapLayers = {
        light: L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {attribution: '¬©OpenStreetMap'}),
        dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {attribution: '¬©OpenStreetMap'}),
        satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {attribution: '¬©Esri'})
    };
    let currentLayerStr = 'light';
    const map = L.map('map', {zoomControl: false}).setView(trackerPos, 14);
    mapLayers[currentLayerStr].addTo(map);

    // Use new dog icon
    let marker = L.marker(trackerPos, {icon: dogIcon}).addTo(map).bindPopup("Oreo");
    let userMarker = L.circleMarker([0,0], {radius: 8, color: '#FFFFFF', fillColor: '#0066FF', fillOpacity: 1, weight: 3}).addTo(map);

    function toggleMapStyle() {
        map.removeLayer(mapLayers[currentLayerStr]);
        currentLayerStr = (currentLayerStr === 'light') ? 'satellite' : (currentLayerStr === 'satellite' ? 'dark' : 'light');
        map.addLayer(mapLayers[currentLayerStr]);
    }

    function toggleLogs() {
        const modal = document.getElementById('logs-modal');
        modal.style.display = (modal.style.display === "block") ? "none" : "block";
    }

    function addLog(msg) {
        const container = document.getElementById('log-container');
        const time = new Date().toLocaleTimeString();
        container.innerHTML = `<div class="log-entry">[${time}] ${msg}</div>` + container.innerHTML;
    }

    const client = new Paho.MQTT.Client("wss://broker.hivemq.com:8884/mqtt", "web_" + Math.random());
    document.addEventListener("visibilitychange", () => { if (!document.hidden && !client.isConnected()) connectMQTT(); });
    client.onConnectionLost = (responseObject) => { if (responseObject.errorCode !== 0) setTimeout(connectMQTT, 2000); };

    client.onMessageArrived = (msg) => {
        if (msg.destinationName.includes("status")) {
            const s = msg.payloadString;
            document.getElementById('status').innerText = s;
            document.getElementById('dot-sys').style.background = (s === "ONLINE") ? "#34c759" : "#ff3b30";
            addLog(`System is ${s}`);
        } else {
            const data = JSON.parse(msg.payloadString);
            document.getElementById('gps-status').innerText = (data.gps === "FIXED") ? "GPS OK" : "SEARCHING";
            document.getElementById('gps-status').style.color = (data.gps === "FIXED") ? "#34c759" : "#ff9500";
            let v = parseFloat(data.bat);
            document.getElementById('bat-val').innerText = Math.max(0, Math.min(100, Math.round(((v - 3.4) / (4.2 - 3.4)) * 100))) + "%";
            document.querySelectorAll('.btn-mode').forEach(b => b.classList.remove('active-SAFE', 'active-WALK', 'active-LOST'));
            const currentBtn = document.getElementById('mode-' + data.mode);
            if(currentBtn) currentBtn.classList.add('active-' + data.mode);
            if (data.lat && data.lon) {
                trackerPos = [data.lat, data.lon];
                marker.setLatLng(trackerPos);
                if (isTracking) updateRoute();
                updateDistanceDisplay();
            }
            if (data.mode === "ESCAPE") { alert("üö® ALERT: OREO HAS LEFT THE GEOFENCE!"); addLog("üö® ALERT: OREO HAS LEFT THE GEOFENCE!"); }
        }
    };

    function updateDistanceDisplay() { if (userPos && trackerPos) { const d = map.distance(userPos, trackerPos); document.getElementById('dist-val').innerText = (d < 1000) ? Math.round(d) + " m" : (d/1000).toFixed(1) + " km"; } }
    function centerMap() { map.flyTo(trackerPos, 18); }
    function toggleTracking() { isTracking = !isTracking; const btn = document.getElementById('track-btn-fab'); if (isTracking) { btn.classList.add('tracking-active'); updateRoute(); } else { btn.classList.remove('tracking-active'); if (routingControl) map.removeControl(routingControl); } }
    function updateRoute() { if (!isTracking || !userPos || !trackerPos) return; if (routingControl) map.removeControl(routingControl); routingControl = L.Routing.control({ waypoints: [L.latLng(userPos[0], userPos[1]), L.latLng(trackerPos[0], trackerPos[1])], createMarker: () => null, lineOptions: { styles: [{ color: '#0066FF', weight: 6, opacity: 0.8 }] }, show: false, addWaypoints: false }).addTo(map); }
    function toggleFence(active) { if (active) { homeMarker = L.marker(trackerPos, {draggable: true}).addTo(map); fenceCircle = L.circle(trackerPos, {radius: 50, color: '#0066FF'}).addTo(map); homeMarker.on('drag', (e) => fenceCircle.setLatLng(e.target.getLatLng())); homeMarker.on('dragend', () => { client.send(new Paho.MQTT.Message("SETHOME")).destinationName = TOPIC_BASE + "/setMode"; addLog("Home position updated."); }); client.send(new Paho.MQTT.Message("FENCE_ON")).destinationName = TOPIC_BASE + "/setMode"; addLog("Geofence enabled."); } else { if(fenceCircle) map.removeLayer(fenceCircle); if(homeMarker) map.removeLayer(homeMarker); client.send(new Paho.MQTT.Message("FENCE_OFF")).destinationName = TOPIC_BASE + "/setMode"; addLog("Geofence disabled."); } }
    function sendMode(m) { client.send(new Paho.MQTT.Message(m)).destinationName = TOPIC_BASE + "/setMode"; addLog(`Mode changed to ${m}`); }
    function connectMQTT() { client.connect({useSSL:true, onSuccess: () => { client.subscribe(TOPIC_BASE + "/location"); client.subscribe(TOPIC_BASE + "/status"); addLog("Connected to MQTT Broker."); }}); }

    connectMQTT();
    if (navigator.geolocation) { navigator.geolocation.watchPosition(p => { userPos = [p.coords.latitude, p.coords.longitude]; userMarker.setLatLng(userPos); updateDistanceDisplay(); }, null, {enableHighAccuracy: true}); navigator.geolocation.getCurrentPosition(p => { userPos = [p.coords.latitude, p.coords.longitude]; map.flyTo(userPos, 15); }); }
</script>
</body>
</html>
