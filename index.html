<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Oreo Tracker Pro</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    
    <style>
        :root { --primary-blue: #0066FF; --bg-grey: #F2F2F7; --text-dark: #1C1C1E; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0; background: var(--bg-grey); display: flex; flex-direction: column; height: 100vh; overflow: hidden; color: var(--text-dark); }
        
        /* HEADER */
        .header-bar { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: white; font-size: 16px; font-weight: 700; border-bottom: 1px solid #e5e5ea; z-index: 10; }
        .refresh-btn { background: #f2f2f7; border: none; padding: 8px 12px; border-radius: 20px; font-size: 16px; cursor: pointer; color: var(--primary-blue); }
        .status-pill { padding: 4px 10px; border-radius: 12px; font-size: 11px; display: flex; align-items: center; gap: 5px; background: #f2f2f7; color: #666; font-weight: 600;}
        .dot { height: 6px; width: 6px; border-radius: 50%; display: inline-block; }

        /* INFO PANEL */
        .info-panel { background: white; padding: 15px 20px; display: flex; flex-direction: column; gap: 15px; border-bottom-left-radius: 24px; border-bottom-right-radius: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); z-index: 2; }
        .info-stats { display: flex; justify-content: space-around; text-align: center; }
        .info-label { font-size: 11px; color: #8e8e93; text-transform: uppercase; margin-bottom: 4px; display: block; }
        .info-val { font-size: 18px; font-weight: 700; }
        
        /* MAP */
        .map-container { flex-grow: 1; position: relative; }
        #map { height: 100%; width: 100%; z-index: 1; }
        .fab-container { position: absolute; bottom: 30px; right: 20px; display: flex; flex-direction: column; gap: 12px; z-index: 1000; }
        .fab-btn { width: 50px; height: 50px; background: white; border-radius: 50%; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border: none; font-size: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; }

        /* LOGS MODAL */
        #logs-modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-body { background: white; margin: 15% auto; padding: 20px; width: 85%; border-radius: 20px; max-height: 60%; overflow-y: auto; }
        .log-line { font-family: monospace; font-size: 12px; padding: 5px 0; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>

<div class="header-bar">
    <div>üê∂ Oreo Tracker</div>
    <div style="display:flex; gap:8px; align-items:center;">
        <div class="status-pill"><span id="dot-sys" class="dot" style="background:#ff3b30;"></span> <span id="status">OFFLINE</span></div>
        <button class="refresh-btn" onclick="window.location.reload()">üîÑ</button>
    </div>
</div>

<div class="info-panel">
    <div class="info-stats">
        <div><span class="info-label">Battery</span><span id="bat-val" class="info-val">--%</span></div>
        <div><span class="info-label">Distance</span><span id="dist-val" class="info-val">-- m</span></div>
        <div><span class="info-label">Signal (CSQ)</span><span id="gps-status" class="info-val" style="font-size:14px; color:#ff9500;">WAIT</span></div>
    </div>
</div>

<div class="map-container">
    <div id="map"></div>
    <div class="fab-container">
        <button class="fab-btn" onclick="toggleLogs()">üìú</button>
        <button class="fab-btn" onclick="toggleMapStyle()">üó∫Ô∏è</button>
        <button class="fab-btn" onclick="centerMap()">üéØ</button>
    </div>
</div>

<div id="logs-modal" onclick="toggleLogs()">
    <div class="modal-body" onclick="event.stopPropagation()">
        <h3 style="margin-top:0;">System Logs</h3>
        <div id="log-content"></div>
    </div>
</div>

<script>
    const TOPIC_BASE = "Oreo_Safe_Tracker";
    let trackerPos = [14.5995, 120.9842], userPos = null;
    let currentLayerStr = 'light';

    // Battery Voltage to % Logic for 3.7V Lipo
    function getBatteryPercentage(voltage) {
        let v = parseFloat(voltage);
        if (v >= 4.10) return 100;
        if (v >= 4.00) return 90;
        if (v >= 3.90) return 80;
        if (v >= 3.80) return 60;
        if (v >= 3.70) return 40;
        if (v >= 3.60) return 20;
        if (v <= 3.50) return 5;
        return 0;
    }

    // Leaflet Setup
    const mapLayers = {
        light: L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png'),
        satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}')
    };
    const map = L.map('map', {zoomControl: false}).setView(trackerPos, 14);
    mapLayers[currentLayerStr].addTo(map);

    const dogIcon = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/616/616408.png', 
        iconSize: [40, 40], iconAnchor: [20, 40]
    });
    let marker = L.marker(trackerPos, {icon: dogIcon}).addTo(map);
    let userMarker = L.circleMarker([0,0], {radius: 8, color: 'white', fillColor: '#0066FF', fillOpacity: 1, weight: 3}).addTo(map);

    // Logging
    function addLog(msg) {
        const logBox = document.getElementById('log-content');
        const time = new Date().toLocaleTimeString();
        logBox.innerHTML = `<div class="log-line"><b>[${time}]</b> ${msg}</div>` + logBox.innerHTML;
    }
    function toggleLogs() { const m = document.getElementById('logs-modal'); m.style.display = (m.style.display === 'block') ? 'none' : 'block'; }

    // MQTT Connection
    const client = new Paho.MQTT.Client("wss://broker.hivemq.com:8884/mqtt", "oreo_web_" + Math.random().toString(16).substr(2, 8));
    
    client.onConnectionLost = (responseObject) => {
        addLog("‚ùå Connection Lost: " + responseObject.errorMessage);
        document.getElementById('status').innerText = "DISCONNECTED";
        document.getElementById('dot-sys').style.background = "#ff3b30";
    };

    client.onMessageArrived = (msg) => {
        // Handle ONLINE/OFFLINE status
        if (msg.destinationName.includes("status")) {
            const s = msg.payloadString;
            document.getElementById('status').innerText = s;
            document.getElementById('dot-sys').style.background = (s === "ONLINE") ? "#34c759" : "#ff3b30";
            addLog("Device is " + s);
        } 
        // Handle Location Data
        else if (msg.destinationName.includes("data")) {
            try {
                const data = JSON.parse(msg.payloadString);
                
                // Update Battery
                document.getElementById('bat-val').innerText = getBatteryPercentage(data.bat) + "%";
                
                // Update Signal Quality (CSQ 0-31)
                document.getElementById('gps-status').innerText = data.sig + " CSQ";

                // Update Position (Matching hardware keys 'lat' and 'lng')
                if (data.lat != "0.000000" && data.lng != "0.000000") {
                    trackerPos = [parseFloat(data.lat), parseFloat(data.lng)];
                    marker.setLatLng(trackerPos);
                    
                    // Update Distance from user phone
                    if (userPos) {
                        let d = Math.round(map.distance(userPos, trackerPos));
                        document.getElementById('dist-val').innerText = d + " m";
                    }
                }
            } catch(e) { addLog("JSON Error: " + e); }
        }
    };

    function connectMQTT() {
        addLog("Connecting to Broker...");
        client.connect({
            useSSL: true, 
            onSuccess: () => {
                client.subscribe(TOPIC_BASE + "/#");
                addLog("‚úÖ Connected to MQTT");
            },
            onFailure: (e) => addLog("Connect Fail: " + e.errorMessage)
        });
    }

    // Map Controls
    function centerMap() { map.flyTo(trackerPos, 18); }
    function toggleMapStyle() {
        map.removeLayer(mapLayers[currentLayerStr]);
        currentLayerStr = (currentLayerStr === 'light') ? 'satellite' : 'light';
        mapLayers[currentLayerStr].addTo(map);
    }

    // Start
    connectMQTT();

    // Track User Phone Location
    navigator.geolocation.watchPosition(p => {
        userPos = [p.coords.latitude, p.coords.longitude];
        userMarker.setLatLng(userPos);
    }, null, {enableHighAccuracy: true});

</script>
</body>
</html>
