<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Oreo Tracker Pro</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    
    <style>
        :root { --primary-blue: #0066FF; --bg-grey: #F2F2F7; --text-dark: #1C1C1E; --safe-green: #34c759; --warn-orange: #ff9500; --danger-red: #ff3b30; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0; background: var(--bg-grey); display: flex; flex-direction: column; height: 100vh; overflow: hidden; color: var(--text-dark); }
        
        /* HEADER */
        .header-bar { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: white; font-size: 16px; font-weight: 700; border-bottom: 1px solid #e5e5ea; z-index: 10; }
        .refresh-btn { background: #f2f2f7; border: none; padding: 8px 12px; border-radius: 20px; font-size: 16px; cursor: pointer; color: var(--primary-blue); }
        .status-pill { padding: 4px 10px; border-radius: 12px; font-size: 11px; display: flex; align-items: center; gap: 5px; background: #f2f2f7; color: #666; font-weight: 600;}
        .dot { height: 6px; width: 6px; border-radius: 50%; display: inline-block; }

        /* INFO PANEL */
        .info-panel { background: white; padding: 15px 20px; display: flex; flex-direction: column; gap: 15px; border-bottom-left-radius: 24px; border-bottom-right-radius: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); z-index: 2; }
        .info-stats { display: flex; justify-content: space-around; text-align: center; }
        .info-label { font-size: 11px; color: #8e8e93; text-transform: uppercase; margin-bottom: 4px; display: block; }
        .info-val { font-size: 18px; font-weight: 700; }
        
        .fence-row { display: flex; justify-content: space-between; align-items: center; background: #f9f9f9; padding: 10px 15px; border-radius: 16px; font-size: 13px; font-weight: 500;}
        .switch { position: relative; display: inline-block; width: 40px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #e9e9ea; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--safe-green); }
        input:checked + .slider:before { transform: translateX(16px); }

        /* MAP */
        .map-container { flex-grow: 1; position: relative; }
        #map { height: 100%; width: 100%; z-index: 1; }
        .fab-container { position: absolute; bottom: 30px; right: 20px; display: flex; flex-direction: column; gap: 12px; z-index: 1000; }
        .fab-btn { width: 50px; height: 50px; background: white; border-radius: 50%; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border: none; font-size: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .tracking-active { background: var(--primary-blue) !important; color: white !important; }

        /* BOTTOM SHEET */
        .bottom-sheet { background: white; padding: 20px; border-top-left-radius: 24px; border-top-right-radius: 24px; box-shadow: 0 -4px 20px rgba(0,0,0,0.08); z-index: 10; }
        .mode-controls { display: flex; gap: 10px; margin-top: 10px;}
        .btn-mode { flex: 1; border: none; padding: 14px; border-radius: 30px; color: white; font-weight: 700; font-size: 13px; background: #C7C7CC; cursor: pointer; }
        .active-SAFE { background: var(--safe-green) !important; } 
        .active-WALK { background: var(--warn-orange) !important; } 
        .active-LOST { background: var(--danger-red) !important; } 

        /* LOGS MODAL */
        #logs-modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-body { background: white; margin: 15% auto; padding: 20px; width: 85%; border-radius: 20px; max-height: 60%; overflow-y: auto; }
        .log-line { font-family: monospace; font-size: 12px; padding: 5px 0; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>

<div class="header-bar">
    <div>üê∂ Oreo Tracker</div>
    <div style="display:flex; gap:8px; align-items:center;">
        <div class="status-pill"><span id="dot-sys" class="dot" style="background:#ff3b30;"></span> <span id="status">OFFLINE</span></div>
        <button class="refresh-btn" onclick="window.location.reload()">üîÑ</button>
    </div>
</div>

<div class="info-panel">
    <div class="info-stats">
        <div><span class="info-label">Battery</span><span id="bat-val" class="info-val">--%</span></div>
        <div><span class="info-label">Distance</span><span id="dist-val" class="info-val">-- m</span></div>
        <div><span class="info-label">Signal</span><span id="gps-status" class="info-val" style="font-size:14px; color:#ff9500;">WAIT</span></div>
    </div>
    <div class="fence-row">
        <span>üõ°Ô∏è Geofence (Drag Pin)</span>
        <label class="switch"><input type="checkbox" id="fence-toggle" onchange="toggleFence(this.checked)"><span class="slider"></span></label>
    </div>
</div>

<div class="map-container">
    <div id="map"></div>
    <div class="fab-container">
        <button class="fab-btn" onclick="toggleLogs()">üìú</button>
        <button class="fab-btn" onclick="toggleMapStyle()">üó∫Ô∏è</button>
        <button id="track-btn-fab" class="fab-btn" onclick="toggleTracking()">üë£</button>
        <button class="fab-btn" onclick="centerMap()">üéØ</button>
    </div>
</div>

<div class="bottom-sheet">
    <span style="font-weight:700;">Select Mode</span>
    <div class="mode-controls">
        <button id="mode-SAFE" class="btn-mode" onclick="sendMode('SAFE')">üè† SAFE</button>
        <button id="mode-WALK" class="btn-mode" onclick="sendMode('WALK')">ü¶Æ WALK</button>
        <button id="mode-LOST" class="btn-mode" onclick="sendMode('LOST')">üö® LOST</button>
    </div>
</div>

<div id="logs-modal" onclick="toggleLogs()">
    <div class="modal-body" onclick="event.stopPropagation()">
        <h3 style="margin-top:0;">System Logs</h3>
        <div id="log-content"></div>
    </div>
</div>

<script>
    const TOPIC_BASE = "Oreo_Safe_Tracker";
    let trackerPos = [14.5995, 120.9842], userPos = null;
    let isTracking = false, routingControl = null;
    let fenceCircle = null, homeMarker = null;
    let currentLayerStr = 'light';
    let currentMode = "SAFE";

    function getBatteryPercentage(voltage) {
        let v = parseFloat(voltage);
        if (v >= 4.10) return 100;
        if (v >= 3.80) return 60;
        if (v >= 3.60) return 20;
        return 5;
    }

    const mapLayers = {
        light: L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png'),
        satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}')
    };
    const map = L.map('map', {zoomControl: false}).setView(trackerPos, 14);
    mapLayers[currentLayerStr].addTo(map);

    const dogIcon = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/616/616408.png', 
        iconSize: [40, 40], iconAnchor: [20, 40]
    });
    let marker = L.marker(trackerPos, {icon: dogIcon}).addTo(map);
    let userMarker = L.circleMarker([0,0], {radius: 8, color: 'white', fillColor: '#0066FF', fillOpacity: 1, weight: 3}).addTo(map);

    function addLog(msg) {
        const logBox = document.getElementById('log-content');
        logBox.innerHTML = `<div class="log-line"><b>[${new Date().toLocaleTimeString()}]</b> ${msg}</div>` + logBox.innerHTML;
    }
    function toggleLogs() { const m = document.getElementById('logs-modal'); m.style.display = (m.style.display === 'block') ? 'none' : 'block'; }

    const client = new Paho.MQTT.Client("wss://broker.hivemq.com:8884/mqtt", "oreo_web_" + Math.random().toString(16).substr(2, 8));
    
    client.onMessageArrived = (msg) => {
        if (msg.destinationName.includes("status")) {
            const s = msg.payloadString;
            document.getElementById('status').innerText = s;
            document.getElementById('dot-sys').style.background = (s === "ONLINE") ? "#34c759" : "#ff3b30";
        } else if (msg.destinationName.includes("data")) {
            const data = JSON.parse(msg.payloadString);
            document.getElementById('bat-val').innerText = getBatteryPercentage(data.bat) + "%";
            document.getElementById('gps-status').innerText = data.sig + " CSQ";

            if (data.lat && data.lng && data.lat != "0.000000") {
                trackerPos = [parseFloat(data.lat), parseFloat(data.lng)];
                marker.setLatLng(trackerPos);
                if (isTracking) updateRoute();
                if (userPos) document.getElementById('dist-val').innerText = Math.round(map.distance(userPos, trackerPos)) + " m";
                
                // Fence Check
                if(fenceCircle) {
                    const distFromHome = map.distance(trackerPos, fenceCircle.getLatLng());
                    if(distFromHome > fenceCircle.getRadius()) {
                        document.getElementById('status').innerText = "BREACH!";
                        document.getElementById('dot-sys').style.background = "red";
                    }
                }
            }
        }
    };

    function connectMQTT() {
        client.connect({useSSL:true, onSuccess: () => {
            client.subscribe(TOPIC_BASE + "/#");
            addLog("‚úÖ Connected to MQTT");
        }});
    }

    function sendMode(mode) {
        currentMode = mode;
        document.querySelectorAll('.btn-mode').forEach(b => b.classList.remove('active-SAFE', 'active-WALK', 'active-LOST'));
        document.getElementById('mode-' + mode).classList.add('active-' + mode);
        
        if (client.isConnected()) {
            const message = new Paho.MQTT.Message(mode);
            message.destinationName = TOPIC_BASE + "/setMode";
            client.send(message);
            addLog("üöÄ Mode Set: " + mode);
        }
    }

    function toggleFence(active) {
        if (active) {
            homeMarker = L.marker(trackerPos, {draggable: true}).addTo(map);
            fenceCircle = L.circle(trackerPos, {radius: 50, color: '#0066FF', fillOpacity: 0.1}).addTo(map);
            homeMarker.on('drag', (e) => fenceCircle.setLatLng(e.target.getLatLng()));
            addLog("üõ°Ô∏è Fence Active (50m)");
        } else {
            if(fenceCircle) map.removeLayer(fenceCircle);
            if(homeMarker) map.removeLayer(homeMarker);
            fenceCircle = null;
            addLog("üõ°Ô∏è Fence Off");
        }
    }

    function toggleTracking() {
        isTracking = !isTracking;
        document.getElementById('track-btn-fab').classList.toggle('tracking-active');
        if (!isTracking && routingControl) map.removeControl(routingControl);
        if (isTracking) updateRoute();
    }

    function updateRoute() {
        if (!isTracking || !userPos) return;
        if (routingControl) map.removeControl(routingControl);
        routingControl = L.Routing.control({
            waypoints: [L.latLng(userPos[0], userPos[1]), L.latLng(trackerPos[0], trackerPos[1])],
            createMarker: () => null, 
            lineOptions: { styles: [{ color: '#0066FF', weight: 6, opacity: 0.6 }] },
            show: false, addWaypoints: false
        }).addTo(map);
    }

    function centerMap() { map.flyTo(trackerPos, 18); }
    function toggleMapStyle() {
        map.removeLayer(mapLayers[currentLayerStr]);
        currentLayerStr = (currentLayerStr === 'light') ? 'satellite' : 'light';
        mapLayers[currentLayerStr].addTo(map);
    }

    connectMQTT();
    navigator.geolocation.watchPosition(p => {
        userPos = [p.coords.latitude, p.coords.longitude];
        userMarker.setLatLng(userPos);
    }, null, {enableHighAccuracy: true});
</script>
</body>
</html>
