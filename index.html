<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Oreo Tracker Pro</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    
    <style>
        :root {
            --primary-blue: #0066FF; /* Matches reference image blue */
            --bg-grey: #F2F2F7;
            --text-dark: #1C1C1E;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0; background: var(--bg-grey); display: flex; flex-direction: column; height: 100vh; overflow: hidden; color: var(--text-dark); }
        
        /* --- TOP HEADER STATS --- */
        .header-bar { display: flex; justify-content: space-between; padding: 12px 20px; background: white; font-size: 14px; font-weight: 600; border-bottom: 1px solid #e5e5ea; }
        .status-pill { padding: 4px 12px; border-radius: 12px; font-size: 12px; display: flex; align-items: center; gap: 6px;}
        .dot { height: 8px; width: 8px; background-color: #bbb; border-radius: 50%; display: inline-block; }

        /* --- INFO & GEOFENCE BAR --- */
        .info-panel { background: white; padding: 15px 20px; display: flex; flex-direction: column; gap: 15px; border-bottom-left-radius: 24px; border-bottom-right-radius: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); z-index: 2; }
        .info-stats { display: flex; justify-content: space-around; text-align: center; }
        .info-label { font-size: 11px; color: #8e8e93; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; display: block; }
        .info-val { font-size: 18px; font-weight: 700; }
        
        .fence-row { display: flex; justify-content: space-between; align-items: center; background: #f9f9f9; padding: 10px 15px; border-radius: 16px; font-size: 13px; font-weight: 500;}
        /* iOS Style Toggle Switch */
        .switch { position: relative; display: inline-block; width: 40px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #e9e9ea; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        input:checked + .slider { background-color: #34c759; }
        input:checked + .slider:before { transform: translateX(16px); }

        /* --- MAP CONTAINER --- */
        .map-container { flex-grow: 1; position: relative; }
        #map { height: 100%; width: 100%; z-index: 1; }

        /* --- FLOATING ACTION BUTTONS (FABs) --- */
        .fab-container {
            position: absolute;
            bottom: 30px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 1000; /* Ensure above map */
        }
        
        .fab-btn {
            width: 48px;
            height: 48px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border: none;
            font-size: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-dark);
        }
        .fab-btn:active { transform: scale(0.95); background: #f2f2f2; }
        /* Active Tracking State (Blue like reference image) */
        .fab-btn.tracking-active {
            background: var(--primary-blue);
            color: white;
        }

        /* --- BOTTOM MODES SHEET --- */
        .bottom-sheet {
            background: white;
            padding: 20px;
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.08);
            z-index: 1001;
        }
        
        .mode-label { font-size: 16px; font-weight: 700; margin-bottom: 15px; display: block; }
        
        .mode-controls { display: flex; gap: 10px; }
        
        .btn-mode {
            flex: 1;
            border: none;
            padding: 14px;
            border-radius: 30px; /* Pill shape */
            color: white;
            font-weight: 700;
            font-size: 13px;
            cursor: pointer;
            transition: 0.2s;
            background: #C7C7CC; /* Default inactive gray */
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        .btn-mode:active { transform: scale(0.97); }
        
        /* Mode Active Colors */
        .active-SAFE { background: #34c759 !important; } /* iOS Green */
        .active-WALK { background: #ff9500 !important; } /* iOS Orange */
        .active-LOST { background: #ff3b30 !important; } /* iOS Red */

        /* Hiding routing text */
        .leaflet-routing-container { display: none; }
        
        /* Small Status Log for debugging (can hide if desired) */
        #status-log { height: 60px; background: #f9f9f9; color: #666; font-family: monospace; font-size: 10px; padding: 10px; overflow-y: scroll; border-top: 1px solid #eee; display: none; /* Hidden by default for cleaner look */}
    </style>
</head>
<body>

<div class="header-bar">
    <div style="display:flex; align-items:center; gap: 8px;">
        <span style="font-size: 18px;">üê∂</span> Oreo Tracker
    </div>
    <div style="display:flex; gap:10px;">
        <div class="status-pill" style="background:#f2f2f7;">
            <span id="dot-sys" class="dot" style="background:#ff3b30;"></span>
            <span id="status">OFFLINE</span>
        </div>
         <div class="status-pill" style="background:#f2f2f7;">
            <span id="dot-gps" class="dot" style="background:#ff9500;"></span>
            <span id="gps-status">WAIT</span>
        </div>
    </div>
</div>

<div class="info-panel">
    <div class="info-stats">
        <div><span class="info-label">Battery</span><span id="bat-val" class="info-val">--%</span></div>
        <div><span class="info-label">Distance</span><span id="dist-val" class="info-val">-- m</span></div>
    </div>
    <div class="fence-row">
        <span>üõ°Ô∏è Geofence (Drag Home Pin)</span>
        <label class="switch">
            <input type="checkbox" id="fence-toggle" onchange="toggleFence(this.checked)">
            <span class="slider"></span>
        </label>
    </div>
</div>

<div class="map-container">
    <div id="map"></div>
    
    <div class="fab-container">
        <button class="fab-btn" onclick="toggleMapStyle()">üó∫Ô∏è</button>
        <button id="track-btn-fab" class="fab-btn" onclick="toggleTracking()">üë£</button>
         <button class="fab-btn" onclick="centerMap()">üéØ</button>
    </div>
</div>

<div id="status-log"></div>

<div class="bottom-sheet">
    <span class="mode-label">Tracking Mode</span>
    <div class="mode-controls">
        <button id="mode-SAFE" class="btn-mode" onclick="sendMode('SAFE')">üè† SAFE</button>
        <button id="mode-WALK" class="btn-mode" onclick="sendMode('WALK')">ü¶Æ WALK</button>
        <button id="mode-LOST" class="btn-mode" onclick="sendMode('LOST')">üö® LOST</button>
    </div>
</div>

<script>
    const TOPIC_BASE = "Oreo_Safe_Tracker";
    let trackerPos = [14.5995, 120.9842], userPos = null;
    let routingControl = null, isTracking = false;
    let fenceCircle = null, homeMarker = null;

    // --- MAP STYLES SETUP ---
    const mapLayers = {
        light: L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {attribution: '¬©OpenStreetMap, ¬©CartoDB'}),
        dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {attribution: '¬©OpenStreetMap, ¬©CartoDB'}),
        satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {attribution: '¬©Esri'})
    };
    let currentLayerStr = 'light';

    // Initialize Map with default layer
    const map = L.map('map', {zoomControl: false}).setView(trackerPos, 14); // zoomControl: false hides default top-left buttons
    mapLayers[currentLayerStr].addTo(map);

    let marker = L.marker(trackerPos).addTo(map).bindPopup("Oreo");
    let userMarker = L.circleMarker([0,0], {radius: 8, color: '#0066FF', fillColor: '#0066FF', fillOpacity: 0.8, weight: 2, color: 'white'}).addTo(map);

    function addLog(msg) {
        console.log(msg); // Use console for cleaner phone UI
        // Uncomment below to use the visible log div
        // const log = document.getElementById('status-log'); log.innerHTML = `<div>[${new Date().toLocaleTimeString()}] ${msg}</div>` + log.innerHTML;
    }

    // --- NEW FUNCTION: TOGGLE MAP STYLE ---
    function toggleMapStyle() {
        map.removeLayer(mapLayers[currentLayerStr]);
        if(currentLayerStr === 'light') currentLayerStr = 'satellite';
        else if(currentLayerStr === 'satellite') currentLayerStr = 'dark';
        else currentLayerStr = 'light';
        map.addLayer(mapLayers[currentLayerStr]);
        addLog("Map style changed to: " + currentLayerStr);
    }

    // --- MQTT SETUP ---
    const client = new Paho.MQTT.Client("wss://broker.hivemq.com:8884/mqtt", "web_" + Math.random());
    
    client.onMessageArrived = (msg) => {
        if (msg.destinationName.includes("status")) {
            const s = msg.payloadString;
            document.getElementById('status').innerText = s;
            document.getElementById('dot-sys').style.background = (s === "ONLINE") ? "#34c759" : "#ff3b30";
        } else {
            const data = JSON.parse(msg.payloadString);
            
            document.getElementById('gps-status').innerText = (data.gps === "FIXED") ? "GPS OK" : "WAIT";
            document.getElementById('dot-gps').style.background = (data.gps === "FIXED") ? "#34c759" : "#ff9500";
            
            let v = parseFloat(data.bat);
            let pct = Math.max(0, Math.min(100, Math.round(((v - 3.4) / (4.2 - 3.4)) * 100)));
            document.getElementById('bat-val').innerText = pct + "%";

            document.querySelectorAll('.btn-mode').forEach(b => b.classList.remove('active-SAFE', 'active-WALK', 'active-LOST'));
            const currentBtn = document.getElementById('mode-' + data.mode);
            if(currentBtn) currentBtn.classList.add('active-' + data.mode);

            if (data.lat && data.lon) {
                trackerPos = [data.lat, data.lon];
                marker.setLatLng(trackerPos);
                if (isTracking) updateRoute();
                updateDistanceDisplay();
            }
            if (data.mode === "ESCAPE") alert("üö® ALERT: OREO HAS LEFT THE GEOFENCE!");
        }
    };

    function updateDistanceDisplay() {
        if (userPos && trackerPos) {
            const d = map.distance(userPos, trackerPos);
            document.getElementById('dist-val').innerText = (d < 1000) ? Math.round(d) + " m" : (d/1000).toFixed(1) + " km";
        }
    }

    // --- UPDATED BUTTON FUNCTIONS ---
    function centerMap() { map.flyTo(trackerPos, 18); }

    function toggleTracking() {
        isTracking = !isTracking;
        const btn = document.getElementById('track-btn-fab');
        if (isTracking) {
            btn.classList.add('tracking-active'); // Turn blue
            updateRoute();
        } else {
            btn.classList.remove('tracking-active'); // Turn white again
            if (routingControl) map.removeControl(routingControl);
        }
    }

    function updateRoute() {
        if (!isTracking || !userPos || !trackerPos) return;
        if (routingControl) map.removeControl(routingControl);
        routingControl = L.Routing.control({
            waypoints: [L.latLng(userPos[0], userPos[1]), L.latLng(trackerPos[0], trackerPos[1])],
            createMarker: () => null,
            lineOptions: { styles: [{ color: '#0066FF', weight: 6, opacity: 0.8 }] },
            show: false, addWaypoints: false, draggableWaypoints: false, fitSelectedRoutes: false
        }).addTo(map);
    }

    function toggleFence(active) {
        if (active) {
            homeMarker = L.marker(trackerPos, {draggable: true}).addTo(map);
            fenceCircle = L.circle(trackerPos, {radius: 50, color: '#0066FF'}).addTo(map);
            homeMarker.on('drag', (e) => fenceCircle.setLatLng(e.target.getLatLng()));
            homeMarker.on('dragend', () => client.send(new Paho.MQTT.Message("SETHOME")).destinationName = TOPIC_BASE + "/setMode");
            client.send(new Paho.MQTT.Message("FENCE_ON")).destinationName = TOPIC_BASE + "/setMode";
            alert("Fence Active. Drag the new pin to adjust Home location.");
        } else {
            if(fenceCircle) map.removeLayer(fenceCircle);
            if(homeMarker) map.removeLayer(homeMarker);
            client.send(new Paho.MQTT.Message("FENCE_OFF")).destinationName = TOPIC_BASE + "/setMode";
        }
    }

    function sendMode(m) {
        client.send(new Paho.MQTT.Message(m)).destinationName = TOPIC_BASE + "/setMode";
    }

    // --- INIT ---
    client.connect({useSSL:true, onSuccess: () => {
        client.subscribe(TOPIC_BASE + "/location");
        client.subscribe(TOPIC_BASE + "/status");
        
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(p => {
                userPos = [p.coords.latitude, p.coords.longitude];
                userMarker.setLatLng(userPos);
                updateDistanceDisplay();
            }, null, {enableHighAccuracy: true});
             navigator.geolocation.getCurrentPosition(p => {
                 userPos = [p.coords.latitude, p.coords.longitude];
                 map.flyTo(userPos, 15);
             });
        }
    }});
</script>
</body>
</html>
