<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oreo Tracker Pro</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f0f2f5; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .stat-group { display: grid; grid-template-columns: 1fr 1fr; background: #2c3e50; color: white; padding: 8px; text-align: center; }
        .fence-panel { background: #fff; padding: 10px; border-bottom: 1px solid #ddd; display: flex; flex-direction: column; gap: 8px; }
        .fence-row { display: flex; justify-content: space-between; align-items: center; font-size: 13px; }
        #map { flex-grow: 1; z-index: 1; }
        #status-log { height: 80px; background: #1e1e1e; color: #00ff00; font-family: monospace; font-size: 11px; padding: 8px; overflow-y: scroll; }
        
        .controls { padding: 10px; background: white; display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; }
        
        button { border: none; padding: 12px 16px; border-radius: 20px; color: white; font-weight: bold; cursor: pointer; font-size: 12px; transition: all 0.2s ease; }
        button:active { transform: scale(0.92); filter: brightness(0.8); }

        .btn-center { background: #9b59b6; width: 48%; }
        .btn-track { background: #3498db; width: 48%; }
        .btn-mode { background: #7f8c8d; flex-grow: 1; }

        /* Active Mode Styles */
        .active-SAFE { background: #27ae60 !important; }
        .active-WALK { background: #f39c12 !important; }
        .active-LOST { background: #e74c3c !important; }
        .tracking-active { background: #2c3e50 !important; border: 2px solid #3498db; }

        input[type=range] { flex-grow: 1; margin: 0 10px; }
        .leaflet-routing-container { display: none; } /* Hide the text turn-by-turn box */
    </style>
</head>
<body>

<div class="stat-group">
    <div>SYSTEM: <span id="status" style="color:#e74c3c;">OFFLINE</span></div>
    <div>GPS: <span id="gps-status" style="color:#f1c40f;">WAITING</span></div>
</div>

<div class="fence-panel">
    <div class="fence-row">
        <b>Geofence Protection</b>
        <input type="checkbox" id="fence-toggle" onchange="toggleFence(this.checked)">
    </div>
    <div class="fence-row">
        <span>Size: <b id="fence-val">50</b>m | Dist: <b id="dist-val">--</b>m</span>
        <input type="range" min="20" max="500" value="50" onchange="updateFenceSize(this.value)">
        <button onclick="setHome()" style="background:#34495e; padding:5px 10px;">üìç HOME</button>
    </div>
</div>

<div id="map"></div>
<div id="status-log"></div>

<div class="controls">
    <button class="btn-center" onclick="centerMap()">üéØ CENTER OREO</button>
    <button id="track-btn" class="btn-track" onclick="toggleTracking()">üö∂ TRACK OREO</button>
    <button id="mode-SAFE" class="btn-mode" onclick="sendMode('SAFE')">üè† SAFE</button>
    <button id="mode-WALK" class="btn-mode" onclick="sendMode('WALK')">ü¶Æ WALK</button>
    <button id="mode-LOST" class="btn-mode" onclick="sendMode('LOST')">üö® LOST</button>
</div>

<script>
    const BASE = "Oreo_Safe_Tracker";
    let trackerPos = [14.5995, 120.9842], userPos = null;
    let fenceCircle = null, homeMarker = null, routingControl = null;
    let isTracking = false;

    const map = L.map('map').setView(trackerPos, 13);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
    let marker = L.marker(trackerPos).addTo(map).bindPopup("Oreo");
    let userMarker = L.circleMarker([0,0], {radius: 7, color: 'blue', fillColor: '#3388ff', fillOpacity: 0.9}).addTo(map);

    function addLog(m) {
        const el = document.getElementById('status-log');
        el.innerHTML = `[${new Date().toLocaleTimeString()}] ${m}<br>` + el.innerHTML;
    }

    // --- LIVE TRACKING LOGIC ---
    function toggleTracking() {
        isTracking = !isTracking;
        const btn = document.getElementById('track-btn');
        if (isTracking) {
            btn.innerText = "üõë STOP TRACKING";
            btn.classList.add('tracking-active');
            updateRoute();
            addLog("Navigation: Tracking path to Oreo enabled.");
        } else {
            btn.innerText = "üö∂ TRACK OREO";
            btn.classList.remove('tracking-active');
            if (routingControl) map.removeControl(routingControl);
            addLog("Navigation: Path disabled.");
        }
    }

    function updateRoute() {
        if (!isTracking || !userPos || !trackerPos) return;
        if (routingControl) map.removeControl(routingControl);
        
        routingControl = L.Routing.control({
            waypoints: [L.latLng(userPos[0], userPos[1]), L.latLng(trackerPos[0], trackerPos[1])],
            routeWhileDragging: false,
            addWaypoints: false,
            createMarker: function() { return null; }, // Don't add extra markers
            lineOptions: { styles: [{ color: '#3498db', opacity: 0.8, weight: 6 }] }
        }).addTo(map);
    }

    // --- GEOFENCE ---
    function setHome() {
        if (homeMarker) map.removeLayer(homeMarker);
        if (fenceCircle) map.removeLayer(fenceCircle);
        homeMarker = L.marker(trackerPos, {draggable: true}).addTo(map);
        fenceCircle = L.circle(trackerPos, {radius: document.getElementById('fence-val').innerText, color: '#3498db'}).addTo(map);
        homeMarker.on('drag', (e) => fenceCircle.setLatLng(e.target.getLatLng()));
        homeMarker.on('dragend', () => client.send(new Paho.MQTT.Message("SETHOME")).destinationName = BASE + "/setMode");
        document.getElementById('fence-toggle').checked = true;
        client.send(new Paho.MQTT.Message("FENCE_ON")).destinationName = BASE + "/setMode";
        addLog("Fence: Home set and draggable.");
    }

    function toggleFence(active) {
        if (!active && fenceCircle) { map.removeLayer(fenceCircle); map.removeLayer(homeMarker); }
        client.send(new Paho.MQTT.Message(active ? "FENCE_ON" : "FENCE_OFF")).destinationName = BASE + "/setMode";
    }

    function updateFenceSize(val) {
        document.getElementById('fence-val').innerText = val;
        if (fenceCircle) fenceCircle.setRadius(val);
        client.send(new Paho.MQTT.Message("FENCE:"+val)).destinationName = BASE + "/setMode";
    }

    // --- MQTT & UPDATES ---
    const client = new Paho.MQTT.Client("wss://broker.hivemq.com:8884/mqtt", "web_" + Math.random());
    client.onMessageArrived = (msg) => {
        if (msg.destinationName.includes("status")) {
            const s = msg.payloadString;
            document.getElementById('status').innerText = s;
            document.getElementById('status').style.color = s === "ONLINE" ? "#2ecc71" : "#e74c3c";
        } else {
            const data = JSON.parse(msg.payloadString);
            document.getElementById('gps-status').innerText = data.gps;
            
            // Update Active Button UI
            document.querySelectorAll('.btn-mode').forEach(b => b.classList.remove('active-SAFE', 'active-WALK', 'active-LOST'));
            const activeBtn = document.getElementById('mode-' + data.mode);
            if (activeBtn) activeBtn.classList.add('active-' + data.mode);

            if (data.lat && data.lon) {
                trackerPos = [data.lat, data.lon];
                marker.setLatLng(trackerPos);
                if (isTracking) updateRoute();
                updateDistance();
            }
        }
    };

    function updateDistance() {
        if (userPos && trackerPos) {
            const d = map.distance(userPos, trackerPos);
            document.getElementById('dist-val').innerText = Math.round(d);
        }
    }

    function centerMap() { map.flyTo(trackerPos, 18); }
    function sendMode(m) { client.send(new Paho.MQTT.Message(m)).destinationName = BASE + "/setMode"; }

    client.connect({useSSL:true, onSuccess: () => {
        client.subscribe(BASE + "/location"); client.subscribe(BASE + "/status");
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(p => {
                userPos = [p.coords.latitude, p.coords.longitude];
                userMarker.setLatLng(userPos);
                if (isTracking) updateRoute();
                updateDistance();
            });
        }
    }});
</script>
</body>
</html>
