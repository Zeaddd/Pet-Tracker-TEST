<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Milo Tracker Pro</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f0f2f5; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .stat-group { display: grid; grid-template-columns: 1fr 1fr; background: #2c3e50; color: white; padding: 8px; text-align: center; }
        .fence-panel { background: #fff; padding: 10px; border-bottom: 1px solid #ddd; display: flex; flex-direction: column; gap: 8px; }
        .fence-row { display: flex; justify-content: space-between; align-items: center; font-size: 13px; }
        #map { flex-grow: 1; z-index: 1; }
        #status-log { height: 80px; background: #1e1e1e; color: #00ff00; font-family: monospace; font-size: 11px; padding: 8px; overflow-y: scroll; }
        .controls { padding: 10px; background: white; display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; }
        button { border: none; padding: 10px 14px; border-radius: 20px; color: white; font-weight: bold; cursor: pointer; font-size: 12px; }
        .btn-center { background: #9b59b6; width: 100%; }
        .btn-safe { background: #27ae60; } .btn-walk { background: #f39c12; } .btn-lost { background: #e74c3c; }
        input[type=range] { flex-grow: 1; margin: 0 10px; }
    </style>
</head>
<body>

<div class="stat-group">
    <div>SYSTEM: <span id="status" style="color:#e74c3c;">OFFLINE</span></div>
    <div>GPS: <span id="gps-status" style="color:#f1c40f;">WAITING</span></div>
</div>

<div class="fence-panel">
    <div class="fence-row">
        <b>Geofence Protection</b>
        <input type="checkbox" id="fence-toggle" onchange="toggleFence(this.checked)">
    </div>
    <div class="fence-row">
        <span>Size: <b id="fence-val">50</b>m</span>
        <input type="range" min="20" max="500" value="50" onchange="updateFenceSize(this.value)">
        <button class="btn-safe" style="padding:5px 10px;" onclick="setHome()">üìç SET HOME</button>
    </div>
</div>

<div id="map"></div>
<div id="status-log"></div>

<div class="controls">
    <button class="btn-center" onclick="centerMap()">üéØ CENTER TO MILO</button>
    <button class="btn-safe" onclick="sendMode('SAFE')">üè† SAFE</button>
    <button class="btn-walk" onclick="sendMode('WALK')">ü¶Æ WALK</button>
    <button class="btn-lost" onclick="sendMode('LOST')">üö® LOST</button>
</div>

<script>
    const BASE = "Milo_99_XyZ_782_Safe_Tracker";
    let trackerPos = [14.5995, 120.9842], fenceCircle = null;

    const map = L.map('map').setView(trackerPos, 16);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
    let marker = L.marker(trackerPos).addTo(map);

    function addLog(m) {
        const el = document.getElementById('status-log');
        el.innerHTML = `[${new Date().toLocaleTimeString()}] ${m}<br>` + el.innerHTML;
    }

    const client = new Paho.MQTT.Client("wss://broker.hivemq.com:8884/mqtt", "web_" + Math.random());
    client.onMessageArrived = (msg) => {
        if (msg.destinationName.includes("status")) {
            const s = msg.payloadString;
            document.getElementById('status').innerText = s;
            document.getElementById('status').style.color = s === "ONLINE" ? "#2ecc71" : "#e74c3c";
        } else {
            const data = JSON.parse(msg.payloadString);
            document.getElementById('gps-status').innerText = data.gps;
            if (data.lat && data.lon) {
                trackerPos = [data.lat, data.lon];
                marker.setLatLng(trackerPos);
                if (data.mode === "ESCAPE") {
                    addLog("üö® ESCAPE DETECTED!");
                    if(fenceCircle) fenceCircle.setStyle({color: 'red'});
                }
            }
        }
    };

    function centerMap() { map.flyTo(trackerPos, 18); }

    function toggleFence(active) {
        if (!active && fenceCircle) { map.removeLayer(fenceCircle); fenceCircle = null; }
        client.send(new Paho.MQTT.Message(active ? "FENCE_ON" : "FENCE_OFF")).destinationName = BASE + "/setMode";
        addLog("Geofence " + (active ? "Enabled" : "Disabled"));
    }

    function setHome() {
        if (fenceCircle) map.removeLayer(fenceCircle);
        fenceCircle = L.circle(trackerPos, {radius: document.getElementById('fence-val').innerText, color: '#3498db'}).addTo(map);
        document.getElementById('fence-toggle').checked = true;
        client.send(new Paho.MQTT.Message("SETHOME")).destinationName = BASE + "/setMode";
        client.send(new Paho.MQTT.Message("FENCE_ON")).destinationName = BASE + "/setMode";
        addLog("Home set & Fence Active.");
    }

    function updateFenceSize(val) {
        document.getElementById('fence-val').innerText = val;
        if (fenceCircle) fenceCircle.setRadius(val);
        client.send(new Paho.MQTT.Message("FENCE:"+val)).destinationName = BASE + "/setMode";
    }

    function sendMode(m) {
        client.send(new Paho.MQTT.Message(m)).destinationName = BASE + "/setMode";
        addLog("Mode: " + m);
    }

    client.connect({useSSL:true, onSuccess: () => {
        client.subscribe(BASE + "/location"); client.subscribe(BASE + "/status");
    }});
</script>
</body>
</html>
