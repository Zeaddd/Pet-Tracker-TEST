<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Oreo Tracker Pro</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    
    <style>
        :root { --primary-blue: #0066FF; --bg-grey: #F2F2F7; --text-dark: #1C1C1E; }
        body { font-family: -apple-system, sans-serif; margin: 0; background: var(--bg-grey); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Layout */
        .header-bar { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: white; border-bottom: 1px solid #e5e5ea; z-index: 10; }
        .status-pill { padding: 4px 10px; border-radius: 12px; font-size: 11px; display: flex; align-items: center; gap: 5px; background: #f2f2f7; font-weight: 600; }
        .dot { height: 6px; width: 6px; border-radius: 50%; display: inline-block; }

        .map-container { flex-grow: 1; position: relative; }
        #map { height: 100%; width: 100%; z-index: 1; }

        /* FABs */
        .fab-container { position: absolute; bottom: 30px; right: 20px; display: flex; flex-direction: column; gap: 12px; z-index: 1000; }
        .fab-btn { width: 50px; height: 50px; background: white; border-radius: 50%; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border: none; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        /* Logs Modal */
        #logs-modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); }
        .modal-body { background: white; margin: 15% auto; padding: 20px; width: 80%; border-radius: 20px; height: 50%; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .log-line { font-family: monospace; font-size: 12px; border-bottom: 1px solid #eee; padding: 6px 0; color: #333; }

        /* Bottom Controls */
        .bottom-sheet { background: white; padding: 20px; border-top-left-radius: 24px; border-top-right-radius: 24px; box-shadow: 0 -4px 20px rgba(0,0,0,0.08); z-index: 10; }
        .mode-controls { display: flex; gap: 10px; margin-top: 10px; }
        .btn-mode { flex: 1; border: none; padding: 15px; border-radius: 30px; color: white; font-weight: bold; cursor: pointer; background: #C7C7CC; }
        .active-SAFE { background: #34c759 !important; } 
        .active-WALK { background: #ff9500 !important; } 
        .active-LOST { background: #ff3b30 !important; }
    </style>
</head>
<body>

<div class="header-bar">
    <div style="font-weight: bold;">üê∂ Oreo Tracker</div>
    <div class="status-pill"><span id="dot-sys" class="dot" style="background:#ff3b30;"></span> <span id="status">OFFLINE</span></div>
</div>

<div class="map-container">
    <div id="map"></div>
    <div class="fab-container">
        <button class="fab-btn" onclick="toggleLogs()">üìú</button>
        <button class="fab-btn" onclick="centerMap()">üéØ</button>
    </div>
</div>

<div class="bottom-sheet">
    <span style="font-weight:700;">Select Mode</span>
    <div class="mode-controls">
        <button id="mode-SAFE" class="btn-mode" onclick="sendMode('SAFE')">üè† SAFE</button>
        <button id="mode-WALK" class="btn-mode" onclick="sendMode('WALK')">ü¶Æ WALK</button>
        <button id="mode-LOST" class="btn-mode" onclick="sendMode('LOST')">üö® LOST</button>
    </div>
</div>

<div id="logs-modal" onclick="toggleLogs()">
    <div class="modal-body" onclick="event.stopPropagation()">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h3 style="margin:0;">System Logs</h3>
            <button onclick="toggleLogs()" style="border:none; background:none; font-size:20px;">‚úï</button>
        </div>
        <div id="log-content"><i>No logs yet...</i></div>
    </div>
</div>

<script>
    const TOPIC_BASE = "Oreo_Safe_Tracker";
    let trackerPos = [14.5995, 120.9842];
    
    // Log function that works even if MQTT is down
    function addLog(msg) {
        const logBox = document.getElementById('log-content');
        if (logBox.innerHTML.includes("No logs yet")) logBox.innerHTML = "";
        const time = new Date().toLocaleTimeString();
        logBox.innerHTML = `<div class="log-line"><b>[${time}]</b> ${msg}</div>` + logBox.innerHTML;
        console.log("LOG:", msg);
    }

    function toggleLogs() {
        const modal = document.getElementById('logs-modal');
        modal.style.display = (modal.style.display === 'block') ? 'none' : 'block';
    }

    // Map Setup
    const map = L.map('map', {zoomControl: false}).setView(trackerPos, 14);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
    
    const dogIcon = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/616/616408.png', 
        iconSize: [40, 40], iconAnchor: [20, 40]
    });
    let marker = L.marker(trackerPos, {icon: dogIcon}).addTo(map);

    // MQTT Setup
    const client = new Paho.MQTT.Client("wss://broker.hivemq.com:8884/mqtt", "user_" + Math.floor(Math.random() * 1000));
    
    client.onConnectionLost = (err) => {
        addLog("‚ùå Connection Lost: " + err.errorMessage);
        document.getElementById('status').innerText = "OFFLINE";
        document.getElementById('dot-sys').style.background = "#ff3b30";
        setTimeout(connectMQTT, 3000);
    };

    client.onMessageArrived = (msg) => {
        try {
            const data = JSON.parse(msg.payloadString);
            addLog("üì• Received Update: " + msg.payloadString);
            // Update mode buttons
            document.querySelectorAll('.btn-mode').forEach(b => b.classList.remove('active-SAFE', 'active-WALK', 'active-LOST'));
            const currentBtn = document.getElementById('mode-' + data.mode);
            if(currentBtn) currentBtn.classList.add('active-' + data.mode);
        } catch(e) {
            addLog("üì• Status: " + msg.payloadString);
        }
    };

    function connectMQTT() {
        addLog("‚è≥ Connecting to Broker...");
        client.connect({
            useSSL: true,
            onSuccess: () => {
                addLog("‚úÖ Connected to MQTT Broker");
                document.getElementById('status').innerText = "ONLINE";
                document.getElementById('dot-sys').style.background = "#34c759";
                client.subscribe(TOPIC_BASE + "/#");
            },
            onFailure: (err) => addLog("‚ùå Connection Failed: " + err.errorMessage)
        });
    }

    function sendMode(mode) {
        addLog("üîò Button Pressed: " + mode);
        if (client.isConnected()) {
            const message = new Paho.MQTT.Message(mode);
            message.destinationName = TOPIC_BASE + "/setMode";
            client.send(message);
            addLog("üöÄ Command Sent to Tracker");
        } else {
            addLog("‚ö†Ô∏è Not connected. Command not sent.");
        }
    }

    function centerMap() { map.flyTo(trackerPos, 18); }

    connectMQTT();
</script>
</body>
</html>
