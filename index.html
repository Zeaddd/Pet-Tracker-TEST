<script>
    const BASE_TOPIC = "Oreo_Safe_Tracker";
    const DATA_TOPIC = "Oreo_Safe_Tracker/data";
    const CMD_TOPIC = "Oreo_Safe_Tracker/setMode";

    let trackerPos = [14.5995, 120.9842], userPos = null;
    let lastMsgTime = 0, routing = null, fence = null;

    // Initialize Map
    let map = L.map('map', { zoomControl: false }).setView(trackerPos, 16);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);

    // Markers
    let dogIcon = L.icon({ 
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/616/616408.png', 
        iconSize: [45, 45],
        iconAnchor: [22, 22] 
    });
    let dogMarker = L.marker(trackerPos, { icon: dogIcon }).addTo(map);
    let userMarker = L.circleMarker([0,0], { radius: 7, color: 'white', fillColor: '#007AFF', fillOpacity: 1, weight: 2 }).addTo(map);

    // MQTT Client
    const client = new Paho.MQTT.Client("wss://broker.hivemq.com:8884/mqtt", "web_" + Math.random());
    
    client.onMessageArrived = (msg) => {
        // Log all incoming traffic to see if hardware is talking
        console.log("Arrived: " + msg.destinationName + " | " + msg.payloadString);

        if(msg.destinationName === DATA_TOPIC) {
            let data = JSON.parse(msg.payloadString);
            lastMsgTime = Date.now();
            
            // Update UI Stats
            // Conversion: 3.4V (0%) to 4.2V (100%)
            let batV = parseFloat(data.bat);
            let batPct = Math.max(0, Math.min(100, Math.round((batV - 3.4) * 125)));
            document.getElementById('bat-txt').innerText = batPct + "%";
            
            // CSQ to Signal Text
            let csq = parseInt(data.csq);
            let signalText = "Weak";
            if(csq > 15) signalText = "Good";
            if(csq > 25) signalText = "Strong";
            document.getElementById('sig-txt').innerText = csq + " (" + signalText + ")";
            
            document.getElementById('sat-txt').innerText = data.sats;
            
            // Update Connection Pill
            document.getElementById('conn-pill').innerText = "ONLINE";
            document.getElementById('conn-pill').className = "pill bg-green";
            
            // Update GPS Pill
            const gp = document.getElementById('gps-pill');
            gp.innerText = "GPS: " + data.gps;
            gp.className = data.gps === "FIX" ? "pill bg-green" : "pill bg-orange";

            // Update Map Position
            if(data.lat !== "0.0") {
                trackerPos = [parseFloat(data.lat), parseFloat(data.lng)];
                dogMarker.setLatLng(trackerPos);
                calculateDistance();
                
                if(data.mode === "LOST") showRoute();
                checkGeofence();
            }
            updateModeButtons(data.mode);
        }
    };

    function calculateDistance() {
        if(!userPos) return;
        let d = map.distance(userPos, trackerPos);
        let text = d > 1000 ? (d/1000).toFixed(2) + " km" : Math.round(d) + " m";
        document.getElementById('dist-display').innerText = "ðŸ“ Distance to Oreo: " + text;
    }

    function toggleFence() {
        if(fence) {
            map.removeLayer(fence);
            fence = null;
            document.getElementById('f-btn').classList.remove('active-glow');
            addLog("Geofence Deactivated");
        } else {
            fence = L.circle(trackerPos, { radius: 60, color: '#34C759', weight: 2, fillOpacity: 0.1 }).addTo(map);
            document.getElementById('f-btn').classList.add('active-glow');
            addLog("Geofence Set (60m)");
        }
    }

    function checkGeofence() {
        if(fence) {
            let dist = map.distance(trackerPos, fence.getLatLng());
            if(dist > 60) {
                document.body.style.border = "5px solid #FF3B30";
                addLog("âš ï¸ ALERT: OREO LEFT SAFE ZONE!");
            } else {
                document.body.style.border = "none";
            }
        }
    }

    function showRoute() {
        if(!userPos) return;
        if(routing) map.removeControl(routing);
        routing = L.Routing.control({
            waypoints: [L.latLng(userPos), L.latLng(trackerPos)],
            createMarker: () => null,
            lineOptions: { styles: [{ color: '#007AFF', weight: 6, opacity: 0.8 }] },
            addWaypoints: false, show: false
        }).addTo(map);
    }

    function centerMap() { map.flyTo(trackerPos, 18); }
    
    function toggleLogs() {
        const pan = document.getElementById('log-panel');
        pan.style.display = (pan.style.display === 'block') ? 'none' : 'block';
        document.getElementById('l-btn').classList.toggle('active-glow');
    }

    function addLog(t) {
        const logContent = document.getElementById('log-content');
        logContent.innerHTML = `<div>[${new Date().toLocaleTimeString()}] ${t}</div>` + logContent.innerHTML;
    }

    function sendMode(m) {
        let message = new Paho.MQTT.Message(m);
        message.destinationName = CMD_TOPIC;
        client.send(message);
        addLog("Sent Command: " + m);
    }

    function updateModeButtons(m) {
        document.querySelectorAll('.m-btn').forEach(b => b.classList.remove('m-active'));
        const btn = document.getElementById('b-'+m);
        if(btn) btn.classList.add('m-active');
    }

    setInterval(() => {
        if(lastMsgTime === 0) return;
        let diff = Math.floor((Date.now() - lastMsgTime) / 1000);
        document.getElementById('time-ago').innerText = diff < 60 ? diff + "s ago" : Math.floor(diff/60) + "m ago";
        
        if(diff > 150) { // 2.5 minutes
            document.getElementById('conn-pill').innerText = "OFFLINE";
            document.getElementById('conn-pill').className = "pill bg-red";
        }
    }, 1000);

    navigator.geolocation.watchPosition(p => {
        userPos = [p.coords.latitude, p.coords.longitude];
        userMarker.setLatLng(userPos);
        calculateDistance();
    }, (err) => console.log(err), { enableHighAccuracy: true });

    client.connect({ 
        useSSL: true, 
        onSuccess: () => {
            client.subscribe(BASE_TOPIC + "/#");
            addLog("Dashboard Connected to Broker");
        },
        onFailure: (err) => {
            addLog("Connection Failed: " + err.errorMessage);
        }
    });
</script>
