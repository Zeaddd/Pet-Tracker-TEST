<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Oreo Elite Dashboard</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css">

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

<style>
:root { --blue:#007AFF; --red:#FF3B30; --green:#34C759; --orange:#FF9500; }

body {
    font-family:-apple-system, sans-serif;
    margin:0; height:100vh; overflow:hidden;
    display:flex; flex-direction:column;
    background:#f0f0f0;
}

.header {
    background:white;
    padding:10px 15px;
    border-bottom:1px solid #ddd;
    z-index:1000;
    box-shadow:0 2px 10px rgba(0,0,0,.1);
}

.top-line {
    display:flex; justify-content:space-between; align-items:center;
}

.pill-box { display:flex; gap:5px; }

.pill {
    padding:3px 8px;
    border-radius:10px;
    color:white;
    font-size:10px;
    font-weight:bold;
}

.bg-green { background:var(--green); }
.bg-red { background:var(--red); }
.bg-orange { background:var(--orange); }
.bg-gray { background:#999; }

.stats-grid {
    display:grid;
    grid-template-columns:repeat(3,1fr);
    font-size:11px;
    margin-top:8px;
    color:#666;
    text-align:center;
}

.dist-banner {
    background:#f0f7ff;
    text-align:center;
    font-size:12px;
    padding:6px;
    border-radius:8px;
    margin-top:8px;
    color:var(--blue);
    font-weight:bold;
    border:1px solid #d0e3ff;
}

#map { flex:1; }

.side-menu {
    position:absolute;
    right:15px;
    top:150px;
    display:flex;
    flex-direction:column;
    gap:12px;
    z-index:1000;
}

.btn-circle {
    width:52px; height:52px;
    border-radius:50%;
    border:none;
    background:white;
    box-shadow:0 4px 15px rgba(0,0,0,.2);
    font-size:22px;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
}

.btn-circle:active { transform:scale(.85); }

.active-glow {
    background:var(--blue);
    color:white;
    animation:pulse 1.5s infinite;
}

@keyframes pulse {
    0% { box-shadow:0 0 0 0 rgba(0,122,255,.7); }
    70% { box-shadow:0 0 0 12px rgba(0,122,255,0); }
    100% { box-shadow:0 0 0 0 rgba(0,122,255,0); }
}

#log-panel {
    display:none;
    position:fixed;
    bottom:85px;
    left:15px;
    right:15px;
    height:150px;
    background:rgba(255,255,255,.98);
    border-radius:15px;
    z-index:2000;
    padding:12px;
    box-shadow:0 -5px 20px rgba(0,0,0,.15);
    overflow-y:auto;
    font-family:monospace;
    font-size:11px;
    border:1px solid #ddd;
}

.mode-bar {
    background:white;
    padding:15px;
    display:flex;
    justify-content:space-around;
    border-top:1px solid #ddd;
}

.m-btn {
    border:none;
    padding:10px 15px;
    border-radius:15px;
    font-weight:bold;
    font-size:11px;
    background:#eee;
    color:#444;
    cursor:pointer;
}

.m-active {
    background:var(--blue);
    color:white;
    box-shadow:0 4px 10px rgba(0,122,255,.3);
}
</style>
</head>

<body>

<div class="header">
    <div class="top-line">
        <b>üê∂ OREO PRO</b>
        <div class="pill-box">
            <span id="conn-pill" class="pill bg-red">OFFLINE</span>
            <span id="gps-pill" class="pill bg-gray">GPS: SEARCH</span>
        </div>
    </div>

    <div class="stats-grid">
        <span>üîã <b id="bat-txt">--%</b></span>
        <span>üì∂ <b id="sig-txt">-- CSQ</b></span>
        <span>üõ∞Ô∏è <b id="sat-txt">0</b> Sats</span>
    </div>

    <div id="dist-display" class="dist-banner">üìç Distance: Calculating...</div>
    <div style="text-align:center;font-size:10px;color:#999;margin-top:4px;">
        Last Signal: <span id="time-ago">Never</span>
    </div>
</div>

<div id="map"></div>

<div class="side-menu">
    <button class="btn-circle" onclick="centerMap()">üéØ</button>
    <button id="f-btn" class="btn-circle" onclick="toggleFence()">üõ°Ô∏è</button>
    <button id="l-btn" class="btn-circle" onclick="toggleLogs()">üìú</button>
    <button class="btn-circle" onclick="location.reload()">üîÑ</button>
</div>

<div id="log-panel"><b>System Events</b><hr><div id="log-content"></div></div>

<div class="mode-bar">
    <button id="b-HOME" class="m-btn" onclick="sendMode('HOME')">HOME</button>
    <button id="b-WALK" class="m-btn" onclick="sendMode('WALK')">WALK</button>
    <button id="b-LOST" class="m-btn" onclick="sendMode('LOST')">LOST</button>
    <button id="b-SAVE" class="m-btn" onclick="sendMode('SAVE')">SAVE</button>
</div>

<script>
const TOPIC = "Oreo_Safe_Tracker";

let trackerPos=[14.5995,120.9842], userPos=null;
let lastMsgTime=0, routing=null, fence=null;

/* MAP */
const map = L.map('map',{zoomControl:false}).setView(trackerPos,16);
L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);

const dogMarker = L.marker(trackerPos,{
    icon:L.icon({
        iconUrl:'https://cdn-icons-png.flaticon.com/512/616/616408.png',
        iconSize:[45,45]
    })
}).addTo(map);

const userMarker = L.circleMarker([0,0],{
    radius:7,color:'white',fillColor:'#007AFF',fillOpacity:1,weight:2
}).addTo(map);

/* MQTT */
const client = new Paho.MQTT.Client(
    "wss://broker.hivemq.com:8884/mqtt",
    "web_"+Math.random()
);

client.onMessageArrived = msg => {
    if(!msg.destinationName.includes("data")) return;

    const data = JSON.parse(msg.payloadString);
    lastMsgTime = Date.now();

    let batPct = Math.round((parseFloat(data.bat)-3.4)*125);
    batPct = Math.max(0,Math.min(100,batPct));
    document.getElementById('bat-txt').innerText = batPct+"%";

    document.getElementById('sig-txt').innerText = data.csq+" CSQ";
    document.getElementById('sat-txt').innerText = data.sats;

    document.getElementById('conn-pill').innerText="ONLINE";
    document.getElementById('conn-pill').className="pill bg-green";

    const gp=document.getElementById('gps-pill');
    gp.innerText="GPS: "+data.gps;
    gp.className="pill "+(data.gps==="FIX"?"bg-green":"bg-orange");

    if(data.lat!=="0.0") {
        trackerPos=[+data.lat,+data.lng];
        dogMarker.setLatLng(trackerPos);
        calculateDistance();
        checkGeofence();
    }

    if(data.mode) {
        data.mode = data.mode.toUpperCase();
        updateModeButtons(data.mode);

        if(data.mode==="LOST") showRoute();
        else if(routing) { map.removeControl(routing); routing=null; }
    }
};

/* FUNCTIONS */
function sendMode(m){
    if(!client.isConnected()){
        addLog("‚ùå MQTT not connected");
        return;
    }
    m=m.toUpperCase();
    updateModeButtons(m);

    const msg=new Paho.MQTT.Message(m);
    msg.destinationName=TOPIC+"/setMode";
    msg.qos=1;
    client.send(msg);
    addLog("Mode request: "+m);
}

function updateModeButtons(m){
    if(!m) return;
    document.querySelectorAll('.m-btn').forEach(b=>b.classList.remove('m-active'));
    const btn=document.getElementById("b-"+m);
    if(btn) btn.classList.add('m-active');
}

function calculateDistance(){
    if(!userPos) return;
    const d=map.distance(userPos,trackerPos);
    document.getElementById('dist-display').innerText =
        "üìç Distance: "+(d>1000?(d/1000).toFixed(2)+" km":Math.round(d)+" m");
}

function toggleFence(){
    if(fence){
        map.removeLayer(fence); fence=null;
        document.getElementById('f-btn').classList.remove('active-glow');
        addLog("Geofence OFF");
    } else {
        fence=L.circle(trackerPos,{radius:
